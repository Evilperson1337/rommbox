<UserControl
    x:Class="RomMbox.UI.Views.PlatformsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:behaviors="clr-namespace:RomMbox.UI.Behaviors"
    xmlns:converters="clr-namespace:RomMbox.UI.Converters"
    xmlns:views="clr-namespace:RomMbox.UI.Views"
    xmlns:system="clr-namespace:System.Windows;assembly=PresentationFramework"
    mc:Ignorable="d"
    Width="800">

    <UserControl.Resources>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <Style x:Key="DarkSecondaryButton" TargetType="Button">
            <Setter Property="Background" Value="#1C2230"/>
            <Setter Property="Foreground" Value="#E6EBF5"/>
            <Setter Property="BorderBrush" Value="#2D374B"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#4A6EDC"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#283042"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkComboBoxItem" TargetType="ComboBoxItem">
            <Setter Property="Background" Value="#1C2230"/>
            <Setter Property="Foreground" Value="#E6EBF5"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="BorderBrush" Value="#2D374B"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="ItemBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="ItemBorder" Property="Background" Value="#283042"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="ItemBorder" Property="Background" Value="#2D374B"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkComboBoxTextBox" TargetType="TextBox">
            <Setter Property="Background" Value="#1C2230"/>
            <Setter Property="Foreground" Value="#E6EBF5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="CaretBrush" Value="#E6EBF5"/>
            <Setter Property="SelectionBrush" Value="#4A6EDC"/>
            <Setter Property="SelectionTextBrush" Value="#E6EBF5"/>
        </Style>

        <Style x:Key="DarkComboBox" TargetType="ComboBox">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Background" Value="#1C2230"/>
            <Setter Property="Foreground" Value="#E6EBF5"/>
            <Setter Property="BorderBrush" Value="#2D374B"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="MinHeight" Value="30"/>
            <Setter Property="IsEditable" Value="False"/>
            <Setter Property="IsTextSearchEnabled" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          Focusable="False"
                                          ClickMode="Press">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="26"/>
                                    </Grid.ColumnDefinitions>
                                    <Border x:Name="ComboBorder"
                                            Grid.ColumnSpan="2"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="4"/>
                                    <ContentPresenter x:Name="ContentSite"
                                                      Margin="8,3,28,3"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Left"
                                                      Content="{TemplateBinding SelectionBoxItem}"
                                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                                      ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"/>
                                    <Border Grid.Column="1"
                                            Background="#1C2230"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="1,0,0,0"
                                            CornerRadius="0,4,4,0">
                                        <Path Margin="0"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"
                                              Fill="#AAB4C8"
                                              Data="M 0 0 L 4 4 L 8 0 Z"/>
                                    </Border>
                                </Grid>
                            </ToggleButton>
                            <TextBox x:Name="PART_EditableTextBox"
                                     Style="{StaticResource DarkComboBoxTextBox}"
                                     Margin="8,3,30,3"
                                     Background="{TemplateBinding Background}"
                                     Visibility="Hidden"
                                     IsReadOnly="True"/>
                            <Popup x:Name="Popup"
                                   Placement="Bottom"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   PlacementTarget="{Binding RelativeSource={RelativeSource TemplatedParent}}"
                                   Width="{Binding ActualWidth, RelativeSource={RelativeSource TemplatedParent}}"
                                   AllowsTransparency="True"
                                   Focusable="False"
                                   PopupAnimation="Fade">
                                <Border x:Name="DropDownBorder"
                                        Background="#1C2230"
                                        BorderBrush="#2D374B"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        MinWidth="{Binding ActualWidth, RelativeSource={RelativeSource TemplatedParent}}">
                                    <ScrollViewer Margin="2" SnapsToDevicePixels="True" HorizontalContentAlignment="Stretch">
                                        <ItemsPresenter KeyboardNavigation.DirectionalNavigation="Contained"/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ComboBorder" Property="BorderBrush" Value="#4A6EDC"/>
                            </Trigger>
                            <Trigger Property="IsEditable" Value="True">
                                <Setter TargetName="PART_EditableTextBox" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="ContentSite" Property="Visibility" Value="Hidden"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="ComboBorder" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <StackPanel Visibility="{Binding IsConfiguring, Converter={StaticResource InverseBoolToVisibility}}">

            <TextBlock Text="Platforms" Style="{StaticResource PageHeader}" Foreground="#FF7F7F7F" FontWeight="Bold"/>
            <TextBlock Text="Map platforms from the RomM server to LaunchBox platforms."
                       Style="{StaticResource HelperText}"
                       Margin="0,0,0,14"/>

            <DockPanel Margin="0,0,0,14">
                <Button Content="Refresh"
                        DockPanel.Dock="Right"
                        Command="{Binding RefreshCommand}"
                        Width="110"
                        HorizontalAlignment="Right"
                        Style="{StaticResource DarkSecondaryButton}"/>
            </DockPanel>

            <DataGrid ItemsSource="{Binding Mappings}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      HeadersVisibility="Column"
                      Height="420"
                      EnableRowVirtualization="False"
                      EnableColumnVirtualization="False"
                      VirtualizingStackPanel.IsVirtualizing="False"
                      Background="#141822"
                      BorderBrush="{StaticResource BorderBrush}"
                      BorderThickness="1"
                      RowBackground="#141822"
                      AlternatingRowBackground="#151A26"
                      GridLinesVisibility="Horizontal"
                      HorizontalGridLinesBrush="#283042"
                      VerticalGridLinesBrush="#283042"
                      SelectionMode="Single"
                      SelectionUnit="FullRow"
                      VerticalContentAlignment="Center"
                      ScrollViewer.VerticalScrollBarVisibility="Visible"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto">

            <!-- Column headers -->
            <DataGrid.ColumnHeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="Background" Value="#1C2230"/>
                    <Setter Property="Foreground" Value="#AAB4C8"/>
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Padding" Value="10,8"/>
                    <Setter Property="BorderBrush" Value="#2D374B"/>
                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                </Style>
            </DataGrid.ColumnHeaderStyle>

            <!-- Cells -->
            <DataGrid.CellStyle>
                <Style TargetType="DataGridCell">
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="BorderBrush" Value="Transparent"/>
                    <Setter Property="Padding" Value="10,6"/>
                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                    <Setter Property="Foreground" Value="#E6EBF5"/>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#141822"/>
                            <Setter Property="BorderBrush" Value="Transparent"/>
                        </Trigger>
                        <DataTrigger Binding="{Binding Exclude}" Value="True">
                            <Setter Property="Opacity" Value="0.55"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.CellStyle>

            <!-- Rows -->
            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <Setter Property="MinHeight" Value="36"/>
                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="#283042"/>
                        </Trigger>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#141822"/>
                        </Trigger>
                        <DataTrigger Binding="{Binding Exclude}" Value="True">
                            <Setter Property="Opacity" Value="0.80"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.Columns>

                <!-- Exclude (TEMPLATE COLUMN for vertical centering) -->
                <DataGridTemplateColumn Header="Exclude" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <CheckBox IsChecked="{Binding Exclude, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- RomM Platform -->
                <DataGridTemplateColumn Header="RomM Platform" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding RomMPlatform}"
                                       VerticalAlignment="Center"
                                       Foreground="#E6EBF5"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- LaunchBox Platform -->
                <DataGridTemplateColumn Header="LaunchBox Platform" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding DataContext.LaunchBoxPlatforms, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                      SelectedItem="{Binding LaunchBoxPlatform, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      IsTextSearchEnabled="False"
                                      StaysOpenOnEdit="True"
                                      behaviors:ContainsFilterComboBoxBehavior.Enable="True"
                                      behaviors:ComboBoxMouseWheelBehavior.EnableRedirect="True"
                                      ItemContainerStyle="{StaticResource DarkComboBoxItem}"
                                      VerticalContentAlignment="Center">
                                <ComboBox.Resources>
                                    <Style TargetType="TextBox" BasedOn="{StaticResource DarkComboBoxTextBox}" />
                                </ComboBox.Resources>
                                <ComboBox.Style>
                                    <Style TargetType="ComboBox" BasedOn="{StaticResource DarkComboBox}">
                                        <Setter Property="IsEnabled" Value="True"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Exclude}" Value="True">
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Setter Property="Opacity" Value="0.55"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ComboBox.Style>
                            </ComboBox>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Configure -->
                <DataGridTemplateColumn Header="Configure" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Configure"
                                    Style="{StaticResource DarkSecondaryButton}"
                                    Command="{Binding DataContext.ConfigureCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>

            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,12,0,0">
                <Button Content="Save"
                        Command="{Binding SaveMappingsCommand}"
                        Style="{StaticResource PrimaryButton}"/>
            </StackPanel>

        </StackPanel>

        <ContentControl Visibility="{Binding IsConfiguring, Converter={StaticResource BoolToVisibility}}"
                        HorizontalAlignment="Stretch">
            <ContentControl.Content>
                <views:PlatformInstallConfigDialog DataContext="{Binding ActiveConfiguration}"/>
            </ContentControl.Content>
        </ContentControl>
    </Grid>
</UserControl>
